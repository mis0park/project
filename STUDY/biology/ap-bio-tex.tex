\documentclass[letterpaper, 11pt]{article}

% =========================================================
% PACKAGES
% =========================================================
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{libertinus}
\usepackage{microtype}

\usepackage{amsmath, amssymb}
\usepackage[version=4]{mhchem}

\usepackage{xcolor}
\usepackage[most]{tcolorbox}
\usepackage{tikz}
\usetikzlibrary{calc}
\usepackage{pgffor}

\usepackage{enumitem}
\usepackage[hidelinks]{hyperref}
\usepackage{eso-pic}
\usepackage{graphicx}
\usepackage{placeins}
\usepackage{marginnote}
\usepackage{fancyhdr}
\usepackage{tocloft} % Essential for the TOC fixes

% =========================================================
% LAYOUT
% =========================================================
\usepackage[
   left=0.75in,
   top=1.875in,
   bottom=0.75in,
   textwidth=5.0in,
   marginparsep=0.5in,
   marginparwidth=1.6in
]{geometry}

\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt}
\emergencystretch=2em
\tolerance=2000

% =========================================================
% DESIGN SYSTEM (Colors & Boxes)
% =========================================================
\definecolor{paperBg}{HTML}{F8F8F6}
\definecolor{ink}{HTML}{1F2937}
\definecolor{muted}{HTML}{6B7280}
\definecolor{rulecol}{HTML}{B8B8B8}

\definecolor{accBlue}{HTML}{8CA7C9}
\definecolor{accGreen}{HTML}{9BBFA8}
\definecolor{accOrange}{HTML}{D2B08A}
\definecolor{accPink}{HTML}{CFA3B3}

\pagecolor{paperBg}
\color{ink}

\tcbset{
  noteBase/.style={
    enhanced, breakable,
    colback=paperBg!92!white,
    colframe=ink!18,
    boxrule=0.4pt,
    arc=2.2mm,
    left=3.2mm, right=3.2mm, top=2.6mm, bottom=2.6mm
  }
}

\newtcolorbox{defn}[1]{noteBase, borderline west={2.2mm}{0pt}{accBlue}, title={Definition}, coltitle=ink, fonttitle=\sffamily\bfseries, before upper={\textbf{#1}\par\smallskip}}
\newtcolorbox{eqn}[1]{noteBase, borderline west={2.2mm}{0pt}{accGreen}, title={Equation}, coltitle=ink, fonttitle=\sffamily\bfseries, before upper={\textbf{#1}\par\smallskip}}
\newtcolorbox{ex}[1]{noteBase, borderline west={2.2mm}{0pt}{accOrange}, title={Example}, coltitle=ink, fonttitle=\sffamily\bfseries, before upper={\textbf{#1}\par\smallskip}}
\newtcolorbox{fig}[1]{noteBase, borderline west={2.2mm}{0pt}{accPink}, title={Diagram}, coltitle=ink, fonttitle=\sffamily\bfseries, before upper={\textbf{#1}\par\smallskip}}

% =========================================================
% TOC CUSTOMIZATION (The Fix)
% =========================================================
\setcounter{tocdepth}{2}
\renewcommand{\contentsname}{AP Biology Structure}

% Unit (Section) Styling
\setlength{\cftbeforesecskip}{1.2em} 
\renewcommand{\cftsecfont}{\sffamily\large\bfseries\color{ink}}
\renewcommand{\cftsecpagefont}{\sffamily\large\bfseries\color{ink}}
\renewcommand{\cftsecleader}{\cftdotfill{\cftnodots}} % No dots for units

% Topic (Subsection) Styling
\setlength{\cftsubsecindent}{1em}      % Slight indent
\setlength{\cftsubsecnumwidth}{3.8em}  % Space for "2.10"
\renewcommand{\cftsubsecfont}{\normalfont\color{ink}}
\renewcommand{\cftsubsecdotsep}{\cftdotsep} % Keep dots for topics

% =========================================================
% HEADER / FOOTER
% =========================================================
\newcommand{\currentunit}{}
\newcommand{\currenttopic}{}

\AddToShipoutPictureBG{%
  \begin{tikzpicture}[remember picture, overlay]
    \draw[line width=0.55pt, rulecol] ([shift={(0.75in, -1.625in)}]current page.north west) -- ([shift={(-0.75in, -1.625in)}]current page.north east);
    \draw[line width=0.55pt, rulecol] ([shift={(6in, -1.625in)}]current page.north west) -- ([shift={(6in, 0.5in)}]current page.south west);
    \node[anchor=north west, inner sep=0pt] at ([shift={(0.875in, -0.75in)}]current page.north west) {\fontsize{15pt}{15pt}\selectfont \textcolor{muted}{\currentunit}};
    \node[anchor=north west, inner sep=0pt] at ([shift={(0.875in, -1.045in)}]current page.north west) {\fontsize{36pt}{36pt}\selectfont \textbf{\currenttopic}};
  \end{tikzpicture}%
}

\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\fancyfoot[R]{\textcolor{muted}{\thepage}}

% =========================================================
% CORE MACROS
% =========================================================
\newcommand{\starttocpage}{%
  \clearpage
  \gdef\currentunit{AP Biology}%
  \gdef\currenttopic{Table of Contents}%
  \phantomsection
}

\newcommand{\startunitpreview}[2]{%
  \FloatBarrier
  \clearpage
  \gdef\currentunit{Unit #1: #2}%
  \gdef\currenttopic{Unit #1 Preview}%
  \phantomsection
  % Add Unit to TOC without a number, using the title slot
  \addcontentsline{toc}{section}{Unit #1: #2}%
}

\newcommand{\starttopic}[3]{%
  \FloatBarrier
  \clearpage
  \xdef\currentunit{#1}%
  \xdef\currenttopic{#2\ \ #3}%
  \phantomsection
  \addcontentsline{toc}{subsection}{\protect\numberline{#2}#3}%
}

\newcommand{\topicstub}[4]{%
  \starttopic{#1}{#2}{#3}
  \section*{Main Notes}
  \begin{defn}{Concept} \textit{Definition goes here...} \end{defn}
  \begin{eqn}{Formula} \[ A = B \] \end{eqn}
  \marginpar{\small \textbf{Tips}\par $\star$ Watch out for...}
}

\newcommand{\makeunit}[3]{%
  \startunitpreview{#1}{#2}
  \section*{Topics in this Unit}
  \begin{itemize}[leftmargin=*]
    \expandafter\foreach \expandafter\tn\expandafter/\expandafter\tt \expandafter in #3 { \item \textbf{\tn}\quad \tt }
  \end{itemize}
  \expandafter\foreach \expandafter\tn\expandafter/\expandafter\tt \expandafter in #3 { \topicstub{Unit #1: #2}{\tn}{\tt}{#1} }
}

% =========================================================
% DATA LISTS
% =========================================================
\newcommand{\Uone}{1.1/Structure of Water, 1.2/Elements of Life, 1.3/Macromolecules, 1.4/Carbohydrates, 1.5/Lipids, 1.6/Nucleic Acids, 1.7/Proteins}
\newcommand{\Utwo}{2.1/Cell Structure, 2.2/Cell Size, 2.3/Plasma Membrane, 2.4/Permeability, 2.5/Membrane Transport, 2.6/Facilitated Diffusion, 2.7/Tonicity, 2.8/Transport Mechanisms, 2.9/Compartmentalization, 2.10/Origins}
\newcommand{\Uthree}{3.1/Enzymes, 3.2/Enzyme Environments, 3.3/Cellular Energy, 3.4/Photosynthesis, 3.5/Cellular Respiration}
\newcommand{\Ufour}{4.1/Cell Communication, 4.2/Signal Transduction Intro, 4.3/Signal Transduction Pathways, 4.4/Feedback, 4.5/Cell Cycle, 4.6/Cell Differentiation}
\newcommand{\Ufive}{5.1/Meiosis, 5.2/Meiosis and Diversity, 5.3/Mendelian Genetics, 5.4/Non-Mendelian Genetics, 5.5/Environmental Phenotypes}
\newcommand{\Usix}{6.1/DNA and RNA Structure, 6.2/DNA Replication, 6.3/Transcription, 6.4/Translation, 6.5/Regulation of Expression, 6.6/Expression and Specialization, 6.7/Mutations, 6.8/Biotechnology}
\newcommand{\Useven}{7.1/Intro to Natural Selection, 7.2/Natural Selection, 7.3/Artificial Selection, 7.4/Population Genetics, 7.5/Hardy-Weinberg, 7.6/Evidence of Evolution, 7.7/Common Ancestry, 7.8/Continuing Evolution, 7.9/Phylogeny, 7.10/Speciation, 7.11/Variations, 7.12/Origins of Life}
\newcommand{\Ueight}{8.1/Responses to Environment, 8.2/Energy Flow, 8.3/Population Ecology, 8.4/Density Effects, 8.5/Community Ecology, 8.6/Biodiversity, 8.7/Disruptions}

% =========================================================
% DOCUMENT START
% =========================================================
\begin{document}

\starttocpage
\tableofcontents

\makeunit{1}{Chemistry of Life}{\Uone}
\makeunit{2}{Cell Structure and Function}{\Utwo}
\makeunit{3}{Cellular Energetics}{\Uthree}
\makeunit{4}{Cell Communication}{\Ufour}
\makeunit{5}{Heredity}{\Ufive}
\makeunit{6}{Gene Expression}{\Usix}
\makeunit{7}{Natural Selection}{\Useven}
\makeunit{8}{Ecology}{\Ueight}

\end{document}